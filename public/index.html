<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parking Booking</title>
  <link rel="icon" href="/logo_new.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page">
    <div class="container">
      <h1>Parking Booking</h1>

      <label for="person">You are:</label>
      <select id="person">
        <option value="none">Who you are</option>
        <option value="Guest">Guest</option>
        <option value="Chris">Chris</option>
        <option value="Tuula">Tuula</option>
        <option value="Katja">Katja</option>
        <option value="Kati">Kati</option>
        <option value="Saima">Saima</option>
        <option value="Patrick">Patrick</option>
        <option value="Vladimir">Vladimir</option>
      </select>

      <div class="confirmation" id="confirmation"></div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // ---------- real-time + calendar logic (unchanged behavior) ----------
    const socket = io();
    let bookings = {};
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    async function loadBookings() {
      try {
        const res = await fetch("/bookings");
        if (res.ok) bookings = await res.json();
      } catch (e) {
        console.error("Failed to load bookings:", e);
      }
    }

    function sendUpdate() {
      socket.emit("update_bookings", bookings);
    }

    async function bookOrUnbook(dateStr) {
      const person = document.getElementById('person').value;
      const confirmation = document.getElementById('confirmation');

      if (person === "none") {
        confirmation.textContent = "Please select who you are before booking.";
        confirmation.style.color = "red";
        renderCalendar(currentMonth, currentYear);
        return;
      }

      if (bookings[dateStr]) {
        if (bookings[dateStr] === person) {
          delete bookings[dateStr];
          confirmation.textContent = `You unbooked ${dateStr}.`;
          confirmation.style.color = "gray";
        } else {
          confirmation.textContent = `This date is already booked by ${bookings[dateStr]}. You cannot change it.`;
          confirmation.style.color = "red";
          return;
        }
      } else {
        bookings[dateStr] = person;
        confirmation.textContent = `Successfully booked ${person} for ${dateStr}.`;
        confirmation.style.color = "green";
      }

      sendUpdate();
      renderCalendar(currentMonth, currentYear);
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar(currentMonth, currentYear);
    }

    function renderCalendar(month, year) {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = "";

      const header = document.createElement('div');
      header.className = "calendar-header";

      const prevButton = document.createElement('button');
      prevButton.className = "cal-btn";
      prevButton.textContent = "⬅";
      prevButton.onclick = () => changeMonth(-1);

      const nextButton = document.createElement('button');
      nextButton.className = "cal-btn";
      nextButton.textContent = "➡";
      nextButton.onclick = () => changeMonth(1);

      const title = document.createElement('div');
      title.className = "calendar-title";
      title.textContent = `${new Date(year, month).toLocaleString('default', { month: 'long' })} ${year}`;

      header.appendChild(prevButton);
      header.appendChild(title);
      header.appendChild(nextButton);
      calendar.appendChild(header);

      const grid = document.createElement('div');
      grid.className = "calendar-grid";

      const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      for (const w of weekdays) {
        const wd = document.createElement('div');
        wd.className = "weekday";
        wd.textContent = w;
        grid.appendChild(wd);
      }

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      let startDay = firstDay.getDay();
      if (startDay === 0) startDay = 7; // Monday = 1

      for (let i = 1; i < startDay; i++) {
        const empty = document.createElement('div');
        empty.className = "day";
        grid.appendChild(empty);
      }

      const person = document.getElementById('person').value;

      // Today detection
      const today = new Date();
      const isCurrentMonth =
        today.getFullYear() === year &&
        today.getMonth() === month;

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayDiv = document.createElement('div');
        dayDiv.className = "day";

        // Apply thin border to today's date
        if (isCurrentMonth && d === today.getDate()) {
          dayDiv.style.border = "2px solid #000"; //#0078D4"; 
        }

        if (bookings[dateStr]) {
          dayDiv.classList.add('booked');
          if (bookings[dateStr] === person) dayDiv.classList.add('self');
          else dayDiv.classList.add('other');
          dayDiv.innerHTML =
            `<strong>${d}</strong>
            <span style="font-size:12px;margin-top:4px;display:block;">
              ${bookings[dateStr]}
            </span>`;
        } else {
          dayDiv.innerHTML =
            `<strong>${d}</strong>
            <span style="font-size:12px;margin-top:4px;display:block;">
              Available
            </span>`;
        }

        dayDiv.addEventListener('click', () => bookOrUnbook(dateStr), { passive: true });
        grid.appendChild(dayDiv);
      }

      calendar.appendChild(grid);
    }


    // Re-render immediately on person change so available actions update
    document.getElementById('person').addEventListener('change', () => {
      renderCalendar(currentMonth, currentYear);
      document.getElementById('confirmation').textContent = '';
    });

    // Receive updates from server (other clients)
    socket.on('bookings_updated', (data) => {
      bookings = data || {};
      renderCalendar(currentMonth, currentYear);
    });

    // initial load
    (async () => {
      await loadBookings();
      renderCalendar(currentMonth, currentYear);
    })();
  </script>

  <script>
    // Inject snowflake markup and set seasonal theme classes.
    (function(){
      try{
        const params = new URLSearchParams(window.location.search);
        const forceSnow = params.get('snow'); // use ?snow=1 to force snow for testing
        const themeParam = (params.get('theme') || '').toLowerCase(); // use ?theme=dec or ?theme=janfeb for testing
        const now = new Date();
        const month = now.getMonth();

        // Determine whether to show snow
        const showSnow = (forceSnow === '1') || month === 11 || month === 0;

        // Apply theme class: explicit ?theme=dec or ?theme=janfeb overrides month check
        if (themeParam === 'dec' || themeParam === 'december') {
          document.body.classList.add('theme-december');
        } else if (themeParam === 'jan' || themeParam === 'feb' || themeParam === 'janfeb' || themeParam === 'winter') {
          document.body.classList.add('theme-janfeb');
        } else {
          // apply based on current month
          if (month === 11) document.body.classList.add('theme-december');
          else if (month === 0 || month === 1) document.body.classList.add('theme-janfeb');
        }

        if (!showSnow) return;
        if (document.querySelector('.snowflakes')) return; // avoid duplicates

        const html = `
          <div class="snowflakes" aria-hidden="true">
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
            <div class="snowflake"><div class="inner">❅</div></div>
          </div>`;

        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        document.body.appendChild(wrapper.firstElementChild);
      }catch(e){ console.error('Snow injection failed', e); }
    })();
  </script>
</body>
</html>
